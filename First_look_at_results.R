## Standard import & preliminary analysis script for multiple results files from ImageJ
##
##
## Results in .csv-format, additional Group-identifying txt-file (Groups.txt)
##
## best used in an RStudio Project in the results-folder
##
##
## requires tidyverse, beeswarm and vroom packages
##
## example: Filopodia density and Membrane recruitment results generated by the macro in this repo
##
## Oct 2020 Joachim Fuchs



library(tidyverse)
library(ggbeeswarm)
library(vroom)


# Change pattern to file format of results files
# also make sure to be specific enough to exclude unrelated files of same file-format in the folder
dirlist_Filo <- list.files("Measurements/", pattern = "Filopodia.csv$")
dirlist_PM <- list.files("Measurements/", pattern = "PMrecruitment.csv$")

# loads all files at once
filo_data <- vroom::vroom(file.path("Measurements", dirlist_Filo), id = "Image_ID")
PM_data <- vroom::vroom(file.path("Measurements", dirlist_PM), id = "Image_ID")

groups <- read_delim("Groups.txt", delim = "\t")

## if you have an excel file for the groups, you would uncomment and run these lines instead
# library(readxl)
# groups <- read_xlsx("Groups.xlsx")



# Data cleaning of Filopodia files & merge with Groups
F_clean <- filo_data %>% select(!Channel) %>% 
  extract(Image_ID, regex = "_(.+)_", into = "ROI") %>%
  left_join(groups, by = "Image", "ROI")



# Data cleaning of Plasma-membrane files
PM_clean <- PM_data %>% 
  extract(Image_ID, c("Image","ROI"), regex = "Measurements/(.+)_(.+)_PM.+") %>% 
  extract(Label, regex = "tif:(.+):(.)$", into = c("Location","Channel")) %>% 
  mutate(Channel = fct_recode(Channel, "fGFP" = "1", 
                              "fGFP" = "1",
                              "PRG2" = "4"))


## This is where the magic happens
# Calculate Membrane to cytosol or perinuclear ratios
PM_clean <- PM_clean  %>% 
  pivot_wider(id_cols = c("Image", "ROI", "Channel"), 
              names_from = "Location", values_from = c(Area:Median)) %>% 
  mutate(MemIntMean = Mean_Membrane / Mean_Intracellular,
         MemIntMedian = Median_Membrane / Median_Intracellular,
         #MemPeriMean = Mean_Membrane / Mean_Perinuclear,
         #MemPeriMedian = Median_Membrane / Median_Perinuclear 
  ) %>% 
  select(c(Image:Channel, MemIntMean:MemIntMedian)) 


all_cells_clean <- F_clean %>% 
  left_join(filter(PM_clean, Channel == "PRG2"), by = c("Image", "ROI"))


write.table(all_cells_clean, "Exp_A.txt", row.names = F)


## Plotting 

my_theme <- function() {
  theme_minimal() + theme(legend.position = "none", plot.title.position = "plot")
}
theme_set(my_theme())



# Filopodia Density
all_cells_clean %>% 
  ggplot(aes(x = Group, y = FiloDensity, color = Group)) + 
  geom_quasirandom() +
  stat_summary(fun = mean, geom = "crossbar", color = "black", width = 0.6, size = 0.5) + 
  stat_summary(fun.data = "mean_se", geom = "errorbar", color = "black", width = 0.4, size = 0.3) + 
  labs(title = "Filopodia density in N1E",
       subtitle = "") +
  scale_color_brewer(palette = "Set1")

# PM recruitment
all_cells_clean %>% 
  ggplot(aes(x = Group, y = MemIntMean, color = Group)) + 
  geom_quasirandom() +
  stat_summary(fun = mean, geom = "crossbar", color = "black", width = 0.6, size = 0.5) + 
  stat_summary(fun.data = "mean_se", geom = "errorbar", color = "black", width = 0.4, size = 0.3) + 
  labs(title = "Membrane recruitment",
       subtitle = "") +
  #scale_y_continuous(limits = c(0, 1.5)) +
  scale_color_brewer(palette = "Set1")

